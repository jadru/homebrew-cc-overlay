name: Release
on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Inject version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          sed -i '' "s/static let version = \".*\"/static let version = \"${VERSION}\"/" \
            Sources/CCOverlay/Models/Constants.swift
          sed -i '' "s/<string>[0-9]*\.[0-9]*\.[0-9]*<\/string>/<string>${VERSION}<\/string>/" \
            Sources/CCOverlay/Info.plist

      - name: Build universal binary
        run: |
          swift build -c release --arch arm64
          swift build -c release --arch x86_64
          lipo -create \
            .build/arm64-apple-macosx/release/cc-overlay \
            .build/x86_64-apple-macosx/release/cc-overlay \
            -output cc-overlay

      - name: Package
        run: |
          tar -czf cc-overlay-${{ github.ref_name }}-macos.tar.gz cc-overlay
          shasum -a 256 cc-overlay-${{ github.ref_name }}-macos.tar.gz | tee sha256.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: |
            cc-overlay-${{ github.ref_name }}-macos.tar.gz
            sha256.txt

      - name: Compute SHA-256 from GitHub Release
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          RELEASE_URL="https://github.com/jadru/cc-overlay/releases/download/v${VERSION}/cc-overlay-v${VERSION}-macos.tar.gz"
          echo "Downloading release asset from: ${RELEASE_URL}"

          for i in 1 2 3 4 5; do
            HTTP_CODE=$(curl -sL -o /tmp/downloaded.tar.gz -w "%{http_code}" "${RELEASE_URL}")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Download succeeded (attempt ${i})"
              break
            fi
            echo "Attempt ${i} failed with HTTP ${HTTP_CODE}, retrying in 10s..."
            sleep 10
          done

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Failed to download release asset after 5 attempts"
            exit 1
          fi

          DOWNLOAD_SHA256=$(shasum -a 256 /tmp/downloaded.tar.gz | awk '{print $1}')
          LOCAL_SHA256=$(awk '{print $1}' sha256.txt)

          echo "Local SHA-256:      ${LOCAL_SHA256}"
          echo "Downloaded SHA-256:  ${DOWNLOAD_SHA256}"

          if [ "$LOCAL_SHA256" != "$DOWNLOAD_SHA256" ]; then
            echo "::warning::Local and downloaded SHA-256 differ! Using downloaded (authoritative) hash."
          fi

          echo "RELEASE_SHA256=${DOWNLOAD_SHA256}" >> "$GITHUB_ENV"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

      - name: Update Homebrew formula
        run: |
          sed -i '' "s|url \".*\"|url \"https://github.com/jadru/cc-overlay/releases/download/v${VERSION}/cc-overlay-v${VERSION}-macos.tar.gz\"|" Formula/cc-overlay.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${RELEASE_SHA256}\"/" Formula/cc-overlay.rb
          echo "Updated formula: version=${VERSION} sha256=${RELEASE_SHA256}"
          grep -E 'url|sha256' Formula/cc-overlay.rb
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/cc-overlay.rb
          git commit -m "formula: cc-overlay ${VERSION}"
          git push origin HEAD:main

      - name: Sync formula to Homebrew tap
        env:
          TAP_TOKEN: ${{ secrets.TAP_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git clone https://x-access-token:${TAP_TOKEN}@github.com/jadru/homebrew-cc-overlay.git /tmp/tap
          cp Formula/cc-overlay.rb /tmp/tap/Formula/cc-overlay.rb
          cd /tmp/tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/cc-overlay.rb
          git diff --cached --quiet || git commit -m "formula: cc-overlay ${VERSION}"
          git push origin main
